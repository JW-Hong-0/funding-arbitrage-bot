# Funding Arbitrage Bot Handover (2026-01-27)

## TL;DR
- **Bot location**: `Perp_DEX/bots/funding_arbitrage_bot`
- **Shared library**: `Perp_DEX/libs/shared_crypto_lib` (submodule)
- **Main entry**: `src/main_modular.py`
- **Env file**: `Perp_DEX/private/Funding_Arbitrage.env` (set with `BOT_ENV_PATH`)
- **Run**:
  ```bash
  BOT_LOCK_KILL_ALL=1 \
  BOT_ENV_PATH=/home/jeonguk/projects/Perp_DEX/private/Funding_Arbitrage.env \
  .venv/bin/python -m src.main_modular
  ```

This document summarizes the architecture, strategy, recent fixes, and operational cautions for the funding arbitrage modular bot.

---

## 1) What the bot does (Strategy Overview)
The bot seeks funding arbitrage across **GRVT**, **Lighter**, and **Variational**:
- At each **next funding event (nearest upcoming funding time per ticker)**, it chooses the **best hedge pair** that maximizes funding yield **for that event window**.
- It avoids noisy rebalancing by using **hysteresis/threshold rules**, and **minimum opportunity thresholds**.
- It **prioritizes funding event timing**, treating exchanges with no funding at the next event as **0 funding** for that event.

### Key strategy principles
- **Event-first selection**: Use the *next funding event time* as the evaluation anchor. Exchanges that do **not** settle at that event are treated as **0 funding** for that event.
- **Best pair selection**: Pick the pair with highest projected yield for that event window.
- **Rebalance only if meaningful**: Switch only if improvement exceeds threshold (e.g., 1.5x) *and* is above the opportunity floor (bps).
- **Avoid churn**: If benefit is too small, stay in current position to avoid fees/spread losses.

---

## 2) Repo Layout (Perp_DEX)
```
Perp_DEX/
  libs/
    shared_crypto_lib/           # Exchange wrappers (submodule)
    api_docs/                    # Local API docs (Lighter/GRVT/VAR)
  bots/
    funding_arbitrage_bot/
      src/                       # Bot services (monitoring/trading/dashboard)
      test_scripts/              # Test helpers
      logs/                      # Session logs (auto-created)
      .bot.lock                  # Single-process lock
```

### Funding bot files (key)
- `src/main_modular.py`
  - Loads env, initializes exchanges, starts main loop.
  - **Single-process lock** logic lives here.
- `src/monitoring_service.py`
  - Funding rates, next funding times, signal generation.
- `src/trading_service.py`
  - Entry/exit, rebalancing, hedge recovery.
- `src/asset_manager.py`
  - Position aggregation, balances.
- `src/dashboard.py`
  - CLI UI for live status.
- `src/logging_service.py`
  - Session logging + CSV/XLSX export.

### Shared library key modules
- `libs/shared_crypto_lib/exchanges/grvt.py`
- `libs/shared_crypto_lib/exchanges/lighter.py`
- `libs/shared_crypto_lib/exchanges/variational.py`

---

## 3) Operational Safety / Key Cautions
### A) **Multiple processes are fatal**
If multiple `main_modular` processes run simultaneously, **Lighter nonce conflicts** cause 401 errors and partial hedges.
- A lock is now implemented to prevent this.
- Use `BOT_LOCK_KILL_ALL=1` to kill old processes on startup.

### B) 401 errors (Lighter)
401s are usually **auth token/nonce issues**:
- **Auth token expiry or mismatch**
- **Nonce re-use or race**
- **Multiple processes using same API key**

**Mitigations added**:
- Nonce calls are now **serialized via `asyncio.Lock`** in Lighter exchange.
- **Auth token TTL logging** added on issue/refresh.
- Option to use **NonceManagerType.API** in Lighter SDK for safer nonce sync.

### C) GRVT exit ordering
GRVT uses **maker/limit** exits. Hedge entries on other exchanges should not occur until GRVT exit fills.

---

## 4) How Lighter Auth/Nonce Works (Important)
Lighter SDK uses a `nonce_manager`. Nonce must strictly increase **per API key**.
- The SDK supports:
  - **Optimistic (default)**: local increment (fast, riskier)
  - **API**: fetch from server (safe, slower)

### Current implementation
- Controlled by `LIGHTER_NONCE_MODE`:
  - `optimistic` (default)
  - `api` (safer)
- **All Lighter transaction calls** are serialized via `_nonce_lock`:
  - `create_order`
  - `create_market_order_limited_slippage`
  - `cancel_order`
  - `update_leverage`

---

## 5) Environment Variables (Key)
Set in `Perp_DEX/private/Funding_Arbitrage.env`.

**Core**
- `GRVT_API_KEY`, `GRVT_PRIVATE_KEY`, `GRVT_TRADING_ACCOUNT_ID`, `GRVT_ENV`
- `LIGHTER_WALLET_ADDRESS`, `LIGHTER_PRIVATE_KEY`, `LIGHTER_PUBLIC_KEY`, `LIGHTER_API_KEY_INDEX`, `LIGHTER_ENV`
- `VARIATIONAL_WALLET_ADDRESS`, `VARIATIONAL_VR_TOKEN`, `VARIATIONAL_PRIVATE_KEY`

**Lighter controls**
- `LIGHTER_NONCE_MODE=optimistic|api`
- `LIGHTER_AUTH_TTL_S=600`
- `LIGHTER_ERROR_COOLDOWN_S`, `LIGHTER_ERROR_COOLDOWN_AUTH_S`
- `LIGHTER_VERIFY_RETRIES`, `LIGHTER_VERIFY_DELAY_S`

**Lock**
- `BOT_LOCK_KILL_ALL=1` (kill old bot processes before starting)
- `BOT_LOCK_KILL_EXISTING=1` (kill only lock owner)

---

## 6) Logging / Observability
Each session creates:
```
logs/session_YYYYMMDD_HHMMSS/
  balances.csv
  funding.csv
  positions.csv
  signals.csv
  trades.csv
  system.log
```

Key signals to watch:
- `system.log`: auth refresh, 401, cooldowns, errors.
- `signals.csv`: decision/skip reasons, rebalance logic.
- `positions.csv`: net exposure per ticker.

---

## 7) Recent Stability Fixes (Jan 2026)
### In bot (funding_arbitrage_bot)
**Single-process lock** in `src/main_modular.py`:
- `.bot.lock` file + automatic stale cleanup
- `BOT_LOCK_KILL_ALL=1` to kill all existing processes

### In shared library (Lighter)
**Nonce + Auth fixes** in `libs/shared_crypto_lib/exchanges/lighter.py`:
- `asyncio.Lock` around all signing actions
- Auth TTL logging, stored issue/expiry timestamps
- Optional `NonceManagerType.API` via env

### Recent change highlights (important)
- **Nonce 직렬화**: Lighter의 모든 서명 트랜잭션이 `asyncio.Lock` 하에서 순차 처리됨
  - 대상: `create_order`, `create_market_order_limited_slippage`, `cancel_order`, `update_leverage`
- **Auth token TTL 로그**: 토큰 발급/갱신 시 TTL, expires_in 로그 출력
- **NonceManagerType.API 옵션**: `LIGHTER_NONCE_MODE=api` 로 서버 nonce 동기화 가능
- **중복 프로세스 종료 옵션**: `BOT_LOCK_KILL_ALL=1` 사용 시 이전 프로세스 전부 종료 후 실행

---

## 8) Known Risks / TODO
- **401 can still happen** if:
  - Token expires too quickly
  - API outage / rate limits
  - Multiple processes start with different API keys or stale token
- If 401 persists:
  - Separate API keys for **read-only vs trading** is recommended.
  - Implement stronger token refresh schedule (e.g. pre-expiry refresh).

---

## 10) What to monitor during tests (current focus)
These are the **critical signals** we actively watch during live tests:

1) **Lighter 401 frequency**
   - Check `system.log` for `auth error` and `cooldown` entries
   - If 401 spikes → suspect token expiry, nonce conflict, or API throttling

2) **Partial hedge persistence**
   - Look for `PARTIAL_HEDGE` entries in `positions.csv` and `system.log`
   - If partials persist longer than expected → check Lighter cooldown/401

3) **Hedge timing vs GRVT maker fills**
   - GRVT limit exits must fully fill before hedge entries on other venues
   - Ensure no exposure during transition (post-exit, pre-entry)

4) **Funding-event alignment**
   - Make sure next funding event is the anchor
   - Exchanges not settling at the event must be treated as 0 funding

5) **Noisy rebalances / churn**
   - If frequent rebalancing despite low improvement → check thresholds (bps) + hysteresis


---

## 9) Useful Commands
**Find running bots**
```bash
pgrep -f "src.main_modular"
```

**Kill all running bots**
```bash
pgrep -f "src.main_modular" | xargs -r kill -9
```

**Run with kill-all**
```bash
BOT_LOCK_KILL_ALL=1 \
BOT_ENV_PATH=/home/jeonguk/projects/Perp_DEX/private/Funding_Arbitrage.env \
.venv/bin/python -m src.main_modular
```
